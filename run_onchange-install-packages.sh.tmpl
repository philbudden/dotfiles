#!/bin/bash

set -euo pipefail

# Template logic: use hostname as profile, default to 'devcontainer' if not found
{{- $profile := (trimSpace (output "hostname")) }}
{{- $profiles := index .profiles $profile | default (index .profiles "devcontainer") }}
{{- $commands := .commands }}
{{- $managers := index . "pacakage-managers" }}
{{- $packages := .packages }}

echo "ğŸš€ Applying profile: {{ $profile }}"
echo -n "ğŸ“¦ Resolved groups:"
{{- range $profiles }} echo -n " {{ . }}"{{ end }}
echo

# Loop over each group in the profile
{{- range $group := $profiles }}
  echo "ğŸ”§ Processing group: {{ $group }}"

  {{- $groupManagers := index $managers $group }}
  {{- if $groupManagers }}
    {{- range $manager := $groupManagers }}
      echo "  ğŸ› ï¸ Using manager: {{ $manager }}"

      {{- $cmd := index $commands $manager | join " " }}
      {{- $groupPackages := index (index $packages $group) $manager }}

      {{- if $groupPackages }}
        {{- range $pkg := $groupPackages }}
          echo "    ğŸ“¦ Installing {{ $pkg }} with {{ $manager }}"
          {{ $cmd }} {{ $pkg }}
        {{- end }}
      {{- else }}
        echo "    âš ï¸ No packages defined for manager '{{ $manager }}' in group '{{ $group }}'"
      {{- end }}
    {{- end }}
  {{- else }}
    echo "  âš ï¸ No managers defined for group '{{ $group }}'"
  {{- end }}
{{- end }}

